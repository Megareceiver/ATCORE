<?php
class Sales_Debtor_Model extends CI_Model {
    function __construct(){
        parent::__construct();
        $this->void_model = module_model_load('tran','void');
    }

    function items($debtor_no=0){
        if( $debtor_no ){
            $this->db->where('debtor_no',$debtor_no);
        }
        $result = $this->db->select('debtor_no, name, curr_code')->order_by('name ASC')->get('debtors_master');
        if( !is_object($result) ){
           display_error( _("The customers could not be retrieved"));
            return false;
        } else
            return $result->result();
    }

    function get_details($debtor_no=NULL, $to=null, $all=true,$view_customer=true){
        if ($to == null)
            $todate = date("Y-m-d");
        else
            $todate = date2sql($to);

        $past1 = get_company_pref('past_due_days');
        $past2 = 2 * $past1;

        $tran_amount = '(trans.ov_amount + trans.ov_gst + trans.ov_freight + trans.ov_freight_tax + trans.ov_discount)';
        $credit_or_debit = "IF(trans.type=".ST_CUSTCREDIT." OR trans.type=".ST_CUSTPAYMENT." OR trans.type= ".ST_BANKDEPOSIT.", -1, 1)";
        // removed - debtor_trans.alloc from all summations
//         $all = false;
        $tran_alloc = ( $all ) ? 0 : 'trans.alloc';
        $tran_amount .= " - $tran_alloc";

        $value = "IFNULL(  $credit_or_debit * ( $tran_amount ) ,0)";

        $due = "IF (trans.type=".ST_SALESINVOICE.", trans.due_date, trans.tran_date)";

        $this->db->select("Sum($value) AS balance",false);
        $this->db->select("Sum($credit_or_debit *trans.ov_amount) AS amount",false);
        $this->db->select("Sum($credit_or_debit *trans.ov_gst) AS gst",false);
        $this->db->select("Sum($credit_or_debit *trans.ov_freight) AS freight",false);
        $this->db->select("Sum($credit_or_debit *trans.ov_freight_tax) AS freight_tax",false);
        $this->db->select("Sum($credit_or_debit *trans.ov_discount) AS discount",false);
//         $this->db->select("Sum(IF ((TO_DAYS('$todate') - TO_DAYS($due)) >= 0,$value,0)) AS due",false);
//         $this->db->select("Sum(IF ((TO_DAYS('$todate') - TO_DAYS($due)) >= $past1,$value,0)) AS overdue1",false);
//         $this->db->select("Sum(IF ((TO_DAYS('$todate') - TO_DAYS($due)) >= $past2,$value,0)) AS overdue2",false);

        if (!$all){
            $this->db->where("ABS($tran_amount) > ",FLOAT_COMP_DELTA);
        }

        if( !$view_customer ){
            $this->db->select('COUNT(trans.trans_no) AS number');
            $this->db->select('trans.type')->group_by('trans.type');
            $this->db->from('debtor_trans AS trans')->where('trans.tran_date <=',$todate);
            $this->db->where('trans.type <>',ST_CUSTDELIVERY);
//             $this->db->where('trans.type',ST_SALESINVOICE);
            $this->db->order_by('trans.type ASC');
            $this->db->join('debtors_master AS master',"master.debtor_no = trans.debtor_no",'left');

            $this->db->join('gl_trans AS gl',"trans.type=gl.type AND trans.trans_no=gl.type_no AND gl.account=1200",'left');
            $this->db->select("Sum(gl.amount) AS gl_total",false);

        } else {
            $this->db->group_by('master.name');
            $this->db->from('debtors_master AS master');
            $this->db->join('debtor_trans AS trans',"trans.debtor_no = master.debtor_no AND trans.type <> ".ST_CUSTDELIVERY,'LEFT')->where('trans.tran_date <=',$todate);
            $this->db->group_by('master.credit_limit');
        }


        if( $debtor_no ){
            $this->db->where('master.debtor_no',$debtor_no);
        }

        $this->db->join('payment_terms AS term','term.terms_indicator=master.payment_terms','LEFT');
        $this->db->select('term.terms');
        if( $view_customer ){
           $this->db->group_by('term.terms, term.days_before_due, term.day_in_following_month');
        }

        $this->db->join('credit_status AS credit','credit.id=master.credit_status','LEFT');
        $this->db->select('credit.dissallow_invoices, credit.reason_description');
        if( $view_customer ){
            $this->db->group_by('credit.dissallow_invoices, credit.reason_description');
        }



        $this->db->select('master.name, master.curr_code, master.credit_limit');
        $this->void_model->not_voided('trans.type','trans.trans_no');
        $result = $this->db->get();
// bug($this->db->last_query() ); die;
        if( !is_object($result) ){
            //The customer details could not be retrieved
            return false;
        }
        return $result->result();

    }

    function get_debtors($where = array()){
        if( is_array($where) ){
            $this->db->where($where);
        }
        return $this->db->order_by('name ASC')->get('debtors_master')->result();
    }

}